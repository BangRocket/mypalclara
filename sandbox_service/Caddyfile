# Clara Sandbox Service - Caddy Configuration
#
# This configuration provides:
# - Automatic HTTPS via Let's Encrypt
# - API key validation at the proxy level
# - Rate limiting
# - Security headers
#
# Environment variables (set in docker-compose):
# - SANDBOX_DOMAIN: Domain name for the service
# - SANDBOX_API_KEY: API key for authentication

{$SANDBOX_DOMAIN:localhost} {
    # Enable logging
    log {
        output stdout
        format console
    }

    # Security headers
    header {
        # Prevent clickjacking
        X-Frame-Options "DENY"
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        # Enable XSS filter
        X-XSS-Protection "1; mode=block"
        # Remove server header
        -Server
    }

    # Health check endpoint (no auth required)
    @health {
        path /health
    }
    handle @health {
        reverse_proxy sandbox-api:8080
    }

    # API key validation for all other endpoints
    @authenticated {
        header X-API-Key {$SANDBOX_API_KEY}
    }

    # Authenticated requests go to the API
    handle @authenticated {
        reverse_proxy sandbox-api:8080
    }

    # Reject unauthenticated requests
    handle {
        respond "Unauthorized" 401
    }
}

# Development/localhost configuration
:80 {
    # For local development without HTTPS
    @health {
        path /health
    }
    handle @health {
        reverse_proxy sandbox-api:8080
    }

    @authenticated {
        header X-API-Key {$SANDBOX_API_KEY}
    }

    handle @authenticated {
        reverse_proxy sandbox-api:8080
    }

    handle {
        respond "Unauthorized" 401
    }
}
