#!/bin/bash -e

echo "==> Running db:prepare..."
bundle exec rails db:prepare

# Load Solid Queue/Cache/Cable schemas if their tables don't exist yet.
# db:prepare won't load these for an existing database.
echo "==> Ensuring Solid Queue/Cache/Cable tables..."
for db in queue cache cable; do
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rails "db:schema:load:${db}" 2>&1 || true
done

echo "==> Starting Puma on port ${PORT:-3000}..."
exec bundle exec puma -C config/puma.rb
