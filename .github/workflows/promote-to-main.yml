name: Deploy Stage to Main

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm deployment to main'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "::error::You must type 'deploy' to confirm"
          exit 1

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch is stage
        run: |
          if [ "${{ github.ref }}" != "refs/heads/stage" ]; then
            echo "::error::This workflow must be run from the stage branch"
            exit 1
          fi

      - name: Show commits to be deployed
        run: |
          echo "## Commits to be deployed to main:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log origin/main..origin/stage --oneline >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Main
    needs: validate
    runs-on: ubuntu-latest
    environment: main
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create deployment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head stage --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, merging..."
            gh pr merge $EXISTING_PR --merge --admin
          else
            echo "Creating new PR..."
            gh pr create \
              --base main \
              --head stage \
              --title "Deploy stage to main" \
              --body "Deployment from stage to main triggered by @${{ github.actor }}"

            # Get the new PR number and merge
            NEW_PR=$(gh pr list --base main --head stage --json number --jq '.[0].number')
            gh pr merge $NEW_PR --merge --admin
          fi

      - name: Create release tag
        run: |
          VERSION="v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          git tag -a $VERSION -m "Release $VERSION"
          git push origin $VERSION
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Tagged as: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "Stage has been deployed to main." >> $GITHUB_STEP_SUMMARY
